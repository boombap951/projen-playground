# ~~ Generated by projen. To modify, edit .projenrc.js and run "npx projen".

name: Release
on:
  push:
    branches:
      - main
  workflow_dispatch: {}
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CI: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Install dependencies
        run: yarn install --check-files --frozen-lockfile
      - name: Anti-tamper check
        run: git diff --ignore-space-at-eol --exit-code
      - name: Set git identity
        run: |-
          git config user.name "Auto-bump"
          git config user.email "github-actions@github.com"
      - name: Bump to next version
        run: npx projen bump
      - name: Build
        run: npx projen build
      - name: Fail if there are new commits
        id: skip
        run: |
          SKIP_RELEASE="true"
          if [ "$(git ls-remote origin -h ${{ github.ref }} | cut -f1)" == "${{ github.sha }}" ]; then
            SKIP_RELEASE="false"
          fi
          echo "::set-output name=skip_release::$SKIP_RELEASE"
      - name: Create release
        if: steps.skip.outputs.skip_release == "false"
        run: gh release create v$(node -p "require('./package.json').version") -F
          ./CHANGELOG.md -t v$(node -p "require('./package.json').version")
          ./dist/*/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Unbump
        run: npx projen unbump
      - name: Anti-tamper check
        run: git diff --ignore-space-at-eol --exit-code
      - name: Upload artifact
        if: steps.skip.outputs.skip_release == 'false'
        uses: actions/upload-artifact@v2.1.1
        with:
          name: dist
          path: dist
